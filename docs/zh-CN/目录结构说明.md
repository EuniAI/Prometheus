# Prometheus 目录结构说明

本文档详细说明了 Prometheus 项目的目录结构和各个目录的作用。

## 项目根目录结构

```
/Prometheus/
├── prometheus/              # 主源代码包
├── tests/                   # 测试代码
├── docs/                    # 文档
├── .github/                 # GitHub 配置和工作流
├── example.env              # 环境变量示例
├── docker-compose.yml       # Docker 编排配置
├── Dockerfile               # Docker 镜像定义
├── pyproject.toml           # Python 项目配置
├── pytest.ini               # Pytest 配置
├── .coveragerc              # 代码覆盖率配置
├── .gitignore               # Git 忽略规则
├── LICENSE                  # 许可证
├── README.md                # 项目说明
└── CONTRIBUTING.md          # 贡献指南
```

## 核心源代码目录 (prometheus/)

### 1. prometheus/app/ - Web 应用层

FastAPI 驱动的 Web 应用程序，提供 REST API 接口。

```
app/
├── api/routes/              # API 路由定义
│   ├── auth.py             # 认证和登录端点
│   ├── issue.py            # 问题分析主端点 (POST /answer/)
│   ├── repository.py       # 仓库管理（上传、分支创建）
│   ├── github.py           # GitHub token 管理
│   ├── user.py             # 用户信息端点
│   └── invitation_code.py  # 邀请码生成/验证
│
├── services/                # 业务逻辑层
│   ├── issue_service.py           # 核心问题解决编排
│   ├── knowledge_graph_service.py # 知识图谱管理
│   ├── repository_service.py      # 仓库 CRUD 操作
│   ├── user_service.py            # 用户管理
│   ├── llm_service.py             # LLM 提供商集成
│   ├── neo4j_service.py           # Neo4j 数据库操作
│   ├── invitation_code_service.py # 邀请码逻辑
│   ├── database_service.py        # 数据库操作
│   └── base_service.py            # 基础服务类
│
├── models/                  # 数据模型
│   ├── requests/           # 请求模型（输入）
│   ├── response/           # 响应模型（输出）
│   └── entity/             # 数据库实体（User, Repository, InvitationCode）
│
├── middlewares/             # HTTP 中间件
│   └── jwt_middleware.py   # JWT 认证中间件
│
├── decorators/              # 函数装饰器
│   └── require_login.py    # 登录要求装饰器
│
├── main.py                  # FastAPI 应用初始化（生命周期管理）
├── dependencies.py          # 依赖注入设置
├── exception_handler.py     # 自定义异常处理
└── register_login_required_routes.py  # 路由保护逻辑
```

**作用**：
- 提供 RESTful API 接口供外部调用
- 处理用户认证和授权
- 协调各个服务层完成业务逻辑
- 管理应用程序生命周期

### 2. prometheus/lang_graph/ - 多智能体编排（核心）

**102 个 Python 文件**，这是系统的核心智能工作流引擎。

```
lang_graph/
├── graphs/                  # 主入口图
│   ├── issue_graph.py      # 主工作流协调所有问题类型
│   └── issue_state.py      # 状态定义（IssueState, IssueType 枚举）
│
├── nodes/                   # 原子工作流操作（75 个节点文件）
│   ├── 问题分类相关
│   │   ├── issue_classification_subgraph_node.py
│   │   ├── issue_classifier_node.py
│   │   └── issue_classification_context_message_node.py
│   │
│   ├── Bug 流程相关
│   │   ├── issue_bug_subgraph_node.py
│   │   ├── issue_bug_analyzer_node.py
│   │   ├── issue_bug_responder_node.py
│   │   ├── bug_reproduction_subgraph_node.py
│   │   ├── bug_reproducing_*.py（8 个文件）
│   │   └── bug_fix_verification_subgraph_node.py
│   │
│   ├── Feature 流程相关
│   │   ├── issue_feature_subgraph_node.py
│   │   ├── issue_feature_analyzer_node.py
│   │   └── issue_feature_responder_node.py
│   │
│   ├── Question 流程相关
│   │   ├── issue_question_subgraph_node.py
│   │   ├── issue_question_analyzer_node.py
│   │   └── issue_question_response_node.py
│   │
│   ├── Documentation 流程相关
│   │   ├── issue_documentation_subgraph_node.py
│   │   ├── issue_documentation_analyzer_node.py
│   │   └── issue_documentation_responder_node.py
│   │
│   └── 工具节点
│       ├── context_retrieval_subgraph_node.py
│       ├── context_extraction_node.py
│       ├── context_provider_node.py
│       ├── memory_retrieval_node.py
│       ├── memory_storage_node.py
│       ├── git_*.py（4 个文件）
│       ├── build_*.py、test_*.py
│       ├── patch_normalization_node.py
│       └── reset_messages_node.py
│
└── subgraphs/               # 嵌套工作流（32 个子图文件）
    ├── issue_classification_subgraph.py
    ├── issue_bug_subgraph.py
    ├── issue_verified_bug_subgraph.py
    ├── issue_not_verified_bug_subgraph.py
    ├── bug_reproduction_subgraph.py
    ├── bug_fix_verification_subgraph.py
    ├── context_retrieval_subgraph.py
    ├── build_and_test_subgraph.py
    └── run_existing_tests_subgraph.py
```

**作用**：
- 实现复杂的多智能体工作流
- 协调各个专门智能体完成任务
- 管理状态机和状态转换
- 支持嵌套的子工作流

### 3. prometheus/graph/ - 知识图谱

基于 tree-sitter 的 AST 和代码语义表示。

```
graph/
├── knowledge_graph.py       # 主知识图谱类（异步图构建、节点/边管理）
├── file_graph_builder.py    # 文件/目录结构和 AST 构建
└── graph_types.py           # 节点/边类型定义
```

**节点类型**：
- `FileNode`：文件/目录表示
- `ASTNode`：抽象语法树节点
- `TextNode`：文本块节点

**边类型**：
- `HAS_FILE`：目录包含文件
- `HAS_AST`：文件包含 AST
- `HAS_TEXT`：文件包含文本块
- `PARENT_OF`：父子关系
- `NEXT_CHUNK`：文本块顺序

**作用**：
- 构建代码库的图结构表示
- 支持语义级别的代码理解
- 提供高效的图查询接口

### 4. prometheus/parser/ - 代码解析

使用 tree-sitter 实现的语言无关代码解析。

```
parser/
├── tree_sitter_parser.py    # 主解析器（支持 20+ 语言）
└── file_types.py            # 文件类型枚举和检测
```

**支持的语言**：
Python, JavaScript, TypeScript, Java, C++, Go, Rust, Ruby, PHP, C#, Kotlin, Swift, Scala, Shell, YAML, JSON, TOML, Dockerfile, Markdown, SQL, CSS, HTML, XML, Properties 等。

**作用**：
- 无需执行代码即可解析 AST
- 统一的多语言解析接口
- 文件类型自动检测

### 5. prometheus/tools/ - 智能体工具

智能体可以调用的工具，用于代码库操作。

```
tools/
├── graph_traversal.py       # 知识图谱查询工具（586 行）
│   ├── 按文件名/路径查找文件
│   ├── 按类型/文本查找 AST 节点
│   ├── 查找文本块
│   └── 预览和读取文件内容
│
├── file_operation.py        # 文件操作工具（261 行）
│   ├── 读/写文件
│   ├── 编辑特定行
│   ├── 创建/删除文件
│   └── 目录操作
│
├── container_command.py     # Docker 容器执行
└── web_search.py            # Web 搜索集成（Tavily API，142 行）
```

**作用**：
- 为 LLM 智能体提供工具调用能力
- 实现代码库的增删改查
- 支持外部搜索和容器执行

### 6. prometheus/models/ - 核心数据模型

Pydantic 模型定义核心领域对象。

```
models/
├── context.py               # 上下文模型（文件、行号、内容）
├── query.py                 # 查询模型（核心查询、需求、目的）
└── test_patch_result.py     # 测试执行结果
```

**作用**：
- 提供类型安全的数据结构
- 支持数据验证
- 统一数据表示

### 7. prometheus/docker/ - 容器管理

Docker 容器抽象，用于隔离执行。

```
docker/
├── base_container.py        # 抽象基类
├── general_container.py     # 通用 Ubuntu 容器（包含 gcc, cmake, Python, Node.js, Java 等）
└── user_defined_container.py # 用户自定义 Docker 镜像
```

**作用**：
- 提供安全隔离的代码执行环境
- 支持自定义运行时环境
- 管理容器生命周期

### 8. prometheus/neo4j/ - 图数据库处理器

```
neo4j/
└── knowledge_graph_handler.py # Neo4j 持久化层
    ├── 节点创建/查询
    ├── 边创建/查询
    └── 批量操作
```

**作用**：
- 将知识图谱持久化到 Neo4j
- 提供高效的图查询
- 支持批量操作

### 9. prometheus/git/ - Git 操作

```
git/
└── git_repository.py        # Git 仓库抽象
    ├── Clone/Pull 操作
    ├── Commit/分支管理
    ├── Diff 生成
    └── Patch 应用
```

**作用**：
- 管理代码仓库
- 生成和应用补丁
- 版本控制操作

### 10. prometheus/utils/ - 工具函数

**12 个工具模块**：

```
utils/
├── knowledge_graph_utils.py  # 知识图谱格式化/辅助函数（186 行）
├── logger_manager.py         # 日志配置（386 行）
├── memory_utils.py           # 内存/状态管理（215 行）
├── lang_graph_util.py        # LangGraph 工具（111 行）
├── github_utils.py           # GitHub API 辅助函数（101 行）
├── file_utils.py             # 文件操作
├── patch_util.py             # Patch 格式化
├── issue_util.py             # Issue 格式化
├── jwt_utils.py              # JWT token 处理
└── str_util.py               # 字符串工具
```

**作用**：
- 提供通用工具函数
- 简化常见操作
- 统一日志和错误处理

### 11. prometheus/chat_models/ - LLM 集成

```
chat_models/
└── custom_chat_openai.py    # 自定义 OpenAI 包装器
```

**作用**：
- 集成多个 LLM 提供商
- 统一 LLM 调用接口

### 12. prometheus/configuration/ - 配置管理

```
configuration/
└── config.py                # Pydantic 设置模型
    ├── Neo4j 配置
    ├── 知识图谱设置
    ├── LLM 模型选择
    ├── API 密钥管理
    ├── 数据库 URL
    ├── JWT 设置
    └── 日志级别
```

**作用**：
- 统一配置管理
- 环境变量加载
- 类型安全的配置

### 13. prometheus/exceptions/ - 自定义异常

**7 种异常类型**：

```
exceptions/
├── server_exception.py         # HTTP 错误响应
├── llm_exception.py            # LLM 相关错误
├── docker_exception.py         # 容器错误
├── jwt_exception.py            # 认证错误
├── github_exception.py         # GitHub API 错误
├── file_operation_exception.py # 文件操作错误
└── web_search_tool_exception.py # 搜索工具错误
```

**作用**：
- 提供清晰的错误层次结构
- 统一错误处理
- 改善调试体验

### 14. prometheus/script/ - 独立脚本

```
script/
├── github_issue_debug.py    # CLI 工具（397 行）
│   ├── 从 GitHub 获取 issue 详情
│   ├── 上传仓库到 Prometheus
│   ├── 使用 AI 分析
│   └── 输出结果
│
├── generate_jwt_token.py    # JWT 密钥生成工具
└── test_llm_service.py      # LLM 服务测试
```

**作用**：
- 提供命令行工具
- 支持自动化脚本
- 简化常见任务

## 测试目录 (tests/)

**89 个测试文件**，覆盖所有核心模块。

```
tests/
├── app/                     # 应用层测试
│   ├── services/           # 8 个服务测试文件
│   ├── api/                # 6 个 API 端点测试
│   └── middlewares/        # 中间件测试
│
├── lang_graph/             # LangGraph 工作流测试
│   ├── graphs/
│   ├── nodes/
│   └── subgraphs/
│
├── graph/                  # 知识图谱测试（3 个文件）
├── parser/                 # 解析器测试（2 个文件）
├── tools/                  # 工具测试（3 个文件）
├── docker/                 # 容器测试（3 个文件）
├── utils/                  # 工具函数测试（9 个文件）
├── test_utils/             # 测试工具
│   ├── fixtures.py         # Pytest fixtures
│   └── util.py             # 测试辅助函数
│
└── test_project/           # 虚拟 Git 项目用于测试
```

**作用**：
- 确保代码质量
- 支持持续集成
- 提供测试覆盖率报告

## 文档目录 (docs/)

```
docs/
├── Multi-Agent-Architecture.md      # 多智能体架构详解
├── GitHub-Issue-Debug-Guide.md     # CLI 使用指南
├── Evaluation-log.md               # 性能评估指标
├── static/images/                  # 文档图片
└── zh-CN/                          # 中文文档（本文档所在目录）
    ├── 项目概述.md
    ├── 目录结构说明.md
    ├── 核心概念.md
    ├── 快速开始.md
    ├── 开发指南.md
    ├── 架构设计.md
    ├── 相关论文.md
    └── 最近更新.md
```

## 配置文件说明

### pyproject.toml
- Python 项目元数据
- 依赖管理（38 个核心依赖）
- Ruff 代码风格配置
- 构建系统配置

### docker-compose.yml
- 多容器编排（Neo4j, PostgreSQL, Prometheus）
- 网络配置
- 数据卷管理
- 健康检查

### Dockerfile
- 基础镜像：python:3.11-slim
- 依赖：git, build tools, Docker CLI
- 暴露端口：9002
- 启动命令：uvicorn

### example.env
- 环境变量模板
- Neo4j 配置
- LLM API 密钥
- 数据库连接
- JWT 密钥
- 外部服务配置

### pytest.ini
- 测试路径配置
- 测试标记（slow, git）
- Asyncio 模式

### .coveragerc
- 代码覆盖率配置
- 覆盖范围设置

## 总结

Prometheus 项目采用清晰的分层架构：

1. **API 层** (`app/`)：处理 HTTP 请求和响应
2. **业务逻辑层** (`app/services/`)：实现核心业务逻辑
3. **智能体层** (`lang_graph/`)：多智能体工作流编排
4. **知识层** (`graph/`, `neo4j/`)：知识图谱构建和查询
5. **工具层** (`tools/`, `parser/`, `docker/`)：基础工具和服务
6. **配置层** (`configuration/`, `exceptions/`)：配置管理和错误处理

这种架构设计确保了代码的可维护性、可扩展性和可测试性。
