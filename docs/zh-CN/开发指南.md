# Prometheus 开发指南

欢迎参与 Prometheus 的开发！本指南将帮助你了解如何为项目贡献代码。

## 开发环境设置

### 1. Fork 并克隆仓库

```bash
# Fork 仓库（在 GitHub 上点击 Fork 按钮）
# 然后克隆你的 fork
git clone https://github.com/YOUR_USERNAME/Prometheus.git
cd Prometheus

# 添加上游仓库
git remote add upstream https://github.com/EuniAI/Prometheus.git
```

### 2. 创建虚拟环境

```bash
# 使用 venv
python -m venv venv
source venv/bin/activate  # Linux/Mac
# 或 Windows: venv\Scripts\activate

# 或使用 conda
conda create -n prometheus python=3.11
conda activate prometheus
```

### 3. 安装开发依赖

```bash
# 安装构建工具
pip install hatchling

# 安装项目依赖
pip install -e .

# 安装测试和开发依赖
pip install -e .[test]
```

### 4. 配置开发环境

```bash
# 复制环境变量文件
cp example.env .env

# 编辑 .env，配置开发所需的参数
# 确保设置：
# - PROMETHEUS_ENVIRONMENT=local
# - PROMETHEUS_LOG_LEVEL=DEBUG
# - 数据库连接信息
# - LLM API 密钥
```

### 5. 启动数据库服务

```bash
# 使用 docker-compose 启动数据库
docker-compose up neo4j postgres -d

# 或者单独启动
docker run -d --name neo4j \
  -p 7474:7474 -p 7687:7687 \
  -e NEO4J_AUTH=neo4j/password \
  -e NEO4J_PLUGINS='["apoc"]' \
  neo4j

docker run -d --name postgres \
  -p 5432:5432 \
  -e POSTGRES_PASSWORD=password \
  postgres
```

### 6. 验证设置

```bash
# 运行测试确保环境配置正确
pytest tests/ -v -m "not git"
```

## 代码规范

Prometheus 使用 [Ruff](https://docs.astral.sh/ruff/) 进行代码格式化和检查。

### 代码风格

- **风格指南**：Google Python Style Guide
- **行宽**：100 字符
- **缩进**：4 个空格
- **导入排序**：按字母顺序，使用 isort

### 运行代码检查

```bash
# 格式化代码
ruff format .

# 检查代码风格
ruff check .

# 自动修复可修复的问题
ruff check --fix .
```

### 提交前检查清单

在提交代码前，请确保：

- [ ] 代码已格式化：`ruff format .`
- [ ] 通过代码检查：`ruff check .`
- [ ] 所有测试通过：`pytest -v`
- [ ] 添加了必要的测试
- [ ] 更新了相关文档
- [ ] 提交信息清晰描述了更改

## 测试指南

### 测试框架

Prometheus 使用 **pytest** 进行测试，配合以下插件：

- `pytest-asyncio`：测试异步代码
- `pytest-cov`：生成覆盖率报告
- `testcontainers`：Docker 容器集成测试

### 测试结构

```
tests/
├── app/                    # 应用层测试
│   ├── api/               # API 端点测试
│   └── services/          # 服务层测试
├── lang_graph/            # 工作流测试
├── graph/                 # 知识图谱测试
├── parser/                # 解析器测试
├── tools/                 # 工具测试
├── docker/                # 容器测试
├── utils/                 # 工具函数测试
└── test_utils/            # 测试辅助工具
```

### 编写测试

#### 基本测试示例

```python
# tests/utils/test_example.py
import pytest
from prometheus.utils.example import process_data


def test_process_data_success():
    """测试正常情况"""
    result = process_data("input")
    assert result == "expected_output"


def test_process_data_with_invalid_input():
    """测试异常情况"""
    with pytest.raises(ValueError):
        process_data(None)
```

#### 异步测试示例

```python
import pytest


@pytest.mark.asyncio
async def test_async_function():
    """测试异步函数"""
    result = await async_function()
    assert result is not None
```

#### 使用 Fixtures

```python
import pytest


@pytest.fixture
def sample_data():
    """提供测试数据"""
    return {"key": "value"}


def test_with_fixture(sample_data):
    """使用 fixture 的测试"""
    assert sample_data["key"] == "value"
```

### 运行测试

```bash
# 运行所有测试
pytest -v

# 运行特定文件
pytest tests/app/services/test_issue_service.py -v

# 运行特定测试
pytest tests/app/services/test_issue_service.py::test_answer_issue -v

# 运行特定标记的测试
pytest -v -m "not git"  # 跳过需要 git 的测试
pytest -v -m "slow"     # 只运行慢速测试

# 显示详细输出
pytest -v -s

# 并行运行（需要 pytest-xdist）
pytest -n auto
```

### 代码覆盖率

```bash
# 运行测试并生成覆盖率报告
coverage run --source=prometheus -m pytest -v

# 显示覆盖率报告
coverage report -m

# 生成 HTML 报告
coverage html
open htmlcov/index.html
```

### 测试最佳实践

1. **一个测试一个断言**：每个测试应该验证一个特定行为
2. **使用描述性的测试名称**：`test_answer_issue_with_invalid_repo_id`
3. **独立性**：测试之间不应该有依赖关系
4. **可重复性**：测试结果应该一致
5. **快速反馈**：避免不必要的长时间运行

## Git 工作流

### 分支策略

- `main`：稳定的生产代码
- `dev`：开发分支
- `feature/*`：新功能分支
- `bugfix/*`：错误修复分支
- `hotfix/*`：紧急修复分支

### 创建功能分支

```bash
# 同步上游代码
git fetch upstream
git checkout dev
git merge upstream/dev

# 创建功能分支
git checkout -b feature/your-feature-name

# 进行开发...

# 提交更改
git add .
git commit -m "feat: add new feature"

# 推送到你的 fork
git push origin feature/your-feature-name
```

### 提交信息规范

使用 [Conventional Commits](https://www.conventionalcommits.org/) 规范：

```
<type>(<scope>): <subject>

<body>

<footer>
```

**类型 (type)**：

- `feat`：新功能
- `fix`：错误修复
- `docs`：文档更新
- `style`：代码格式（不影响功能）
- `refactor`：重构（既不是新功能也不是修复）
- `test`：添加或修改测试
- `chore`：构建过程或辅助工具的变动

**示例**：

```bash
# 新功能
git commit -m "feat: add support for Rust language parsing"

# 错误修复
git commit -m "fix: handle null pointer in context retrieval"

# 文档更新
git commit -m "docs: update API documentation for issue endpoint"

# 重构
git commit -m "refactor: simplify graph traversal logic"
```

### 提交 Pull Request

1. **确保代码质量**：
   ```bash
   ruff format .
   ruff check --fix .
   pytest -v
   ```

2. **推送到你的 fork**：
   ```bash
   git push origin feature/your-feature-name
   ```

3. **在 GitHub 上创建 PR**：
   - 前往你的 fork 仓库
   - 点击 "Compare & pull request"
   - 填写 PR 描述（见下方模板）
   - 选择目标分支（通常是 `dev`）

4. **PR 描述模板**：

   ```markdown
   ## 描述
   简要说明这个 PR 做了什么。

   ## 相关 Issue
   Closes #123

   ## 变更类型
   - [ ] 新功能
   - [ ] 错误修复
   - [ ] 文档更新
   - [ ] 重构
   - [ ] 测试

   ## 测试
   - [ ] 添加了单元测试
   - [ ] 添加了集成测试
   - [ ] 所有测试通过

   ## 检查清单
   - [ ] 代码遵循项目规范
   - [ ] 更新了相关文档
   - [ ] 没有引入破坏性变更
   - [ ] 提交信息遵循规范
   ```

5. **响应审查**：
   - 及时回复审查意见
   - 根据反馈修改代码
   - 保持专业和尊重

## 添加新功能

### 1. 添加新的智能体节点

创建文件 `prometheus/lang_graph/nodes/your_new_node.py`：

```python
from prometheus.lang_graph.graphs.issue_state import IssueState


async def your_new_node(state: IssueState) -> dict:
    """
    新节点的功能描述。

    Args:
        state: 当前工作流状态

    Returns:
        dict: 更新的状态字段
    """
    # 实现节点逻辑
    result = await some_async_operation()

    # 返回状态更新
    return {
        "new_field": result,
        "messages": state["messages"] + [{"role": "assistant", "content": result}]
    }
```

### 2. 添加新的工具

创建文件 `prometheus/tools/your_new_tool.py`：

```python
from langchain.tools import BaseTool
from pydantic import BaseModel, Field


class YourToolInput(BaseModel):
    """工具输入模型"""
    param1: str = Field(description="参数描述")
    param2: int = Field(default=10, description="可选参数")


class YourNewTool(BaseTool):
    """工具的功能描述"""

    name: str = "your_new_tool"
    description: str = "工具的详细描述，LLM 会根据这个描述决定何时使用"
    args_schema: type[BaseModel] = YourToolInput

    def _run(self, param1: str, param2: int = 10) -> str:
        """
        同步执行逻辑
        """
        # 实现工具逻辑
        result = f"Processed {param1} with {param2}"
        return result

    async def _arun(self, param1: str, param2: int = 10) -> str:
        """
        异步执行逻辑
        """
        # 实现异步逻辑
        return self._run(param1, param2)
```

### 3. 添加新的 API 端点

创建路由 `prometheus/app/api/routes/your_endpoint.py`：

```python
from fastapi import APIRouter, Depends
from prometheus.app.models.requests.your_request import YourRequest
from prometheus.app.models.response.your_response import YourResponse
from prometheus.app.services.your_service import YourService

router = APIRouter(prefix="/your-endpoint", tags=["Your Feature"])


@router.post("/action", response_model=YourResponse)
async def perform_action(
    request: YourRequest,
    service: YourService = Depends(YourService)
):
    """
    执行特定操作

    Args:
        request: 请求参数
        service: 服务实例

    Returns:
        YourResponse: 响应结果
    """
    result = await service.perform_action(request)
    return YourResponse(success=True, data=result)
```

在 `prometheus/app/main.py` 中注册路由：

```python
from prometheus.app.api.routes import your_endpoint

app.include_router(your_endpoint.router, prefix="/v1.2")
```

### 4. 添加新的服务

创建服务 `prometheus/app/services/your_service.py`：

```python
from prometheus.app.services.base_service import BaseService
from prometheus.app.models.requests.your_request import YourRequest


class YourService(BaseService):
    """服务的功能描述"""

    async def perform_action(self, request: YourRequest):
        """
        执行业务逻辑

        Args:
            request: 请求参数

        Returns:
            处理结果
        """
        # 实现业务逻辑
        result = await self._process(request)
        return result

    async def _process(self, request: YourRequest):
        """私有辅助方法"""
        # 实现具体逻辑
        pass
```

### 5. 添加测试

创建测试 `tests/app/services/test_your_service.py`：

```python
import pytest
from prometheus.app.services.your_service import YourService
from prometheus.app.models.requests.your_request import YourRequest


@pytest.fixture
def service():
    """创建服务实例"""
    return YourService()


@pytest.mark.asyncio
async def test_perform_action_success(service):
    """测试正常情况"""
    request = YourRequest(param="value")
    result = await service.perform_action(request)

    assert result is not None
    assert result.status == "success"


@pytest.mark.asyncio
async def test_perform_action_with_invalid_input(service):
    """测试异常情况"""
    request = YourRequest(param="")

    with pytest.raises(ValueError):
        await service.perform_action(request)
```

## 调试技巧

### 1. 使用日志

```python
from prometheus.utils.logger_manager import get_logger

logger = get_logger(__name__)

logger.debug("调试信息")
logger.info("一般信息")
logger.warning("警告信息")
logger.error("错误信息")
logger.exception("异常信息（带堆栈）")
```

### 2. 设置断点

```python
# 使用 pdb
import pdb
pdb.set_trace()

# 或使用 ipdb（更友好）
import ipdb
ipdb.set_trace()
```

### 3. 查看 LangGraph 状态

```python
# 在节点中打印状态
logger.info(f"Current state: {state}")

# 使用 LangGraph 的调试功能
from langgraph.graph import StateGraph

graph = StateGraph(IssueState)
# ... 添加节点和边 ...

# 启用调试模式
compiled_graph = graph.compile(debug=True)
```

### 4. 测试单个节点

```python
# 创建测试状态
from prometheus.lang_graph.graphs.issue_state import IssueState

state = IssueState(
    issue_type="bug",
    issue_content="Test issue",
    # ... 其他必需字段
)

# 直接调用节点
result = await your_node(state)
print(result)
```

## 文档贡献

### 更新现有文档

如果你的更改影响了用户使用方式，请更新相关文档：

```bash
# 编辑文档
vim docs/zh-CN/your-doc.md

# 确保格式正确
# 添加示例代码
# 更新目录
```

### 添加新文档

1. 在 `docs/zh-CN/` 下创建新文件
2. 使用 Markdown 格式
3. 遵循现有文档的风格
4. 在主 README 中添加链接

## 常见问题

### Q: 如何添加对新编程语言的支持？

A: 在 `prometheus/parser/tree_sitter_parser.py` 和 `file_types.py` 中添加语言定义，并安装相应的 tree-sitter 语法包。

### Q: 如何修改 LLM 提示词？

A: 提示词通常在节点文件中定义，搜索相关节点文件并修改提示模板。

### Q: 如何调整知识图谱构建参数？

A: 在 `.env` 文件中修改 `PROMETHEUS_KNOWLEDGE_GRAPH_*` 相关参数。

### Q: 如何禁用某些验证步骤？

A: 在 API 请求中设置相应的标志，如 `run_build=False`。

## 获取帮助

如果在开发过程中遇到问题：

1. **查看文档**：首先查阅相关文档
2. **搜索 Issues**：在 GitHub Issues 中搜索类似问题
3. **询问社区**：在 Discord 或 GitHub Discussions 提问
4. **提交 Issue**：如果是 bug，提交详细的 issue

## 行为准则

参与 Prometheus 项目的所有贡献者应遵守以下准则：

- **尊重**：尊重所有贡献者
- **包容**：欢迎不同背景和观点的人
- **专业**：保持专业和建设性的交流
- **友善**：对新贡献者友善和耐心
- **协作**：优先考虑社区的最佳利益

违反行为准则的行为将受到适当的处理。

## 致谢

感谢所有为 Prometheus 做出贡献的开发者！你的贡献使这个项目更加强大。

查看 [贡献者列表](https://github.com/EuniAI/Prometheus/graphs/contributors) 了解所有贡献者。

---

再次感谢你的贡献！让我们一起构建更好的 Prometheus。
