# Prometheus 快速开始指南

本指南将帮助你快速上手 Prometheus，从安装到运行第一个问题分析。

## 前置要求

在开始之前，请确保你的系统满足以下要求：

### 必需软件

- **Docker**：版本 20.10+
  - 用于运行 Neo4j、PostgreSQL 和 Prometheus 服务
  - [安装 Docker](https://docs.docker.com/get-docker/)

- **Docker Compose**：版本 2.0+
  - 用于多容器编排
  - [安装 Docker Compose](https://docs.docker.com/compose/install/)

- **Python**：3.11 或更高版本（仅用于本地开发）
  - [下载 Python](https://www.python.org/downloads/)

### API 密钥

至少需要以下之一的 LLM API 密钥：

- **OpenAI API Key**：[获取密钥](https://platform.openai.com/api-keys)
- **Anthropic API Key**：[获取密钥](https://console.anthropic.com/)
- **Google Gemini API Key**：[获取密钥](https://ai.google.dev/)

## 快速安装（使用 Docker）

### 1. 克隆仓库

```bash
git clone https://github.com/EuniAI/Prometheus.git
cd Prometheus
```

### 2. 配置环境变量

复制环境变量示例文件：

```bash
cp example.env .env
```

编辑 `.env` 文件，配置必要的参数：

```bash
# 基础配置
PROMETHEUS_ENVIRONMENT=production
PROMETHEUS_LOG_LEVEL=INFO

# Neo4j 配置（使用 docker-compose 的默认值）
PROMETHEUS_NEO4J_URI=bolt://neo4j:7687
PROMETHEUS_NEO4J_USER=neo4j
PROMETHEUS_NEO4J_PASSWORD=password

# PostgreSQL 配置（使用 docker-compose 的默认值）
PROMETHEUS_DATABASE_URL=postgresql+asyncpg://postgres:password@postgres:5432/postgres

# LLM 配置（选择你拥有的 API 密钥）
PROMETHEUS_ADVANCED_MODEL=gpt-4  # 或 claude-3-5-sonnet-20241022, gemini-2.0-flash-exp
PROMETHEUS_BASE_MODEL=gpt-3.5-turbo  # 或 claude-3-haiku-20240307, gemini-1.5-flash

# API 密钥（至少配置一个）
PROMETHEUS_OPENAI_FORMAT_API_KEY=sk-xxx...  # OpenAI API Key
# PROMETHEUS_ANTHROPIC_API_KEY=sk-ant-xxx...  # Anthropic API Key
# PROMETHEUS_GEMINI_API_KEY=xxx...  # Google Gemini API Key

# JWT 密钥（下一步生成）
PROMETHEUS_JWT_SECRET_KEY=  # 暂时留空，下一步填写
```

### 3. 生成 JWT 密钥

运行以下命令生成 JWT 密钥：

```bash
python -m prometheus.script.generate_jwt_token
```

复制输出的密钥，并填写到 `.env` 文件的 `PROMETHEUS_JWT_SECRET_KEY` 中。

### 4. 创建工作目录

```bash
mkdir -p working_dir
```

此目录将用于存储临时文件和克隆的仓库。

### 5. 启动服务

使用 Docker Compose 启动所有服务：

```bash
docker-compose up --build
```

**首次启动**可能需要几分钟时间来下载镜像和构建容器。

启动成功后，你会看到类似的日志输出：

```
neo4j_1       | Started.
postgres_1    | database system is ready to accept connections
prometheus_1  | INFO:     Application startup complete.
prometheus_1  | INFO:     Uvicorn running on http://0.0.0.0:9002
```

### 6. 验证服务

在浏览器中访问以下地址：

- **Prometheus API**：http://localhost:9002/v1.2
- **API 文档**：http://localhost:9002/docs
- **Neo4j 浏览器**：http://localhost:7474
  - 用户名：`neo4j`
  - 密码：`password`（或你在 .env 中设置的密码）

## 使用 API

### 1. 创建用户（可选）

如果你想使用认证功能，可以通过 API 创建用户：

```bash
curl -X POST "http://localhost:9002/v1.2/auth/register" \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123",
    "invitation_code": "test_code"
  }'
```

**注意**：你需要先生成邀请码，或者在代码中禁用邀请码验证。

### 2. 上传仓库

首先需要上传一个代码仓库以构建知识图谱：

```bash
curl -X POST "http://localhost:9002/v1.2/repositories/upload" \
  -H "Content-Type: application/json" \
  -d '{
    "repository_url": "https://github.com/EuniAI/example-repo.git",
    "branch": "main"
  }'
```

返回示例：

```json
{
  "success": true,
  "data": {
    "repository_id": "repo_123",
    "status": "building_knowledge_graph"
  }
}
```

### 3. 分析问题

上传仓库后，可以提交问题进行分析：

```bash
curl -X POST "http://localhost:9002/v1.2/issues/answer/" \
  -H "Content-Type: application/json" \
  -d '{
    "repository_id": "repo_123",
    "issue_type": "auto",
    "issue_title": "Bug: Application crashes on startup",
    "issue_content": "When I run the application, it crashes with a NullPointerException in the main method.",
    "run_build": true,
    "run_test": true,
    "run_reproduction_test": true
  }'
```

返回示例：

```json
{
  "success": true,
  "data": {
    "issue_type": "bug",
    "issue_response": "分析报告...",
    "edit_patch": "--- a/src/main.py\n+++ b/src/main.py\n...",
    "passed_reproducing_test": true,
    "passed_existing_test": true,
    "passed_regression_test": true
  }
}
```

## 使用 CLI 工具

Prometheus 提供了一个命令行工具，可以直接从 GitHub issue 进行分析。

### 1. 安装依赖（本地开发）

```bash
pip install hatchling
pip install .
```

### 2. 获取 GitHub Token

1. 访问 https://github.com/settings/tokens
2. 点击 "Generate new token (classic)"
3. 选择权限：`repo`（访问私有仓库）或 `public_repo`（访问公开仓库）
4. 生成并保存 token

### 3. 运行 CLI 工具

基础用法：

```bash
python -m prometheus.script.github_issue_debug \
    --github-token "ghp_xxxxxxxxxxxxxxxxxxxx" \
    --repo "owner/repository" \
    --issue-number 42
```

完整示例（带验证）：

```bash
python -m prometheus.script.github_issue_debug \
    --github-token "ghp_xxxxxxxxxxxxxxxxxxxx" \
    --repo "microsoft/vscode" \
    --issue-number 123 \
    --prometheus-url "http://localhost:9002/v1.2" \
    --output-file "debug_result.json" \
    --run-build \
    --run-test \
    --run-reproduction-test \
    --run-regression-test \
    --image-name "node:18-slim" \
    --build-commands "npm ci" "npm run build" \
    --test-commands "npm test"
```

### 4. 查看结果

结果会输出到控制台或指定的文件中：

```json
{
  "success": true,
  "issue_info": {
    "repo": "microsoft/vscode",
    "number": 123,
    "title": "Issue Title",
    "url": "https://github.com/microsoft/vscode/issues/123",
    "state": "open"
  },
  "prometheus_result": {
    "patch": "生成的补丁内容...",
    "passed_reproducing_test": true,
    "passed_existing_test": true,
    "passed_regression_test": true,
    "issue_response": "AI 生成的分析报告..."
  }
}
```

## 本地开发设置

如果你想进行本地开发而不是使用 Docker：

### 1. 安装依赖

```bash
pip install hatchling
pip install .
pip install .[test]  # 如果需要运行测试
```

### 2. 启动数据库服务

**PostgreSQL**：

```bash
docker run -d \
  --name prometheus-postgres \
  -p 5432:5432 \
  -e POSTGRES_USER=postgres \
  -e POSTGRES_PASSWORD=password \
  -e POSTGRES_DB=postgres \
  postgres
```

**Neo4j**：

```bash
docker run -d \
  --name prometheus-neo4j \
  -p 7474:7474 -p 7687:7687 \
  -e NEO4J_AUTH=neo4j/password \
  -e NEO4J_PLUGINS='["apoc"]' \
  -e NEO4J_dbms_memory_heap_initial__size=4G \
  -e NEO4J_dbms_memory_heap_max__size=8G \
  neo4j
```

### 3. 更新环境变量

修改 `.env` 中的数据库连接地址为本地地址：

```bash
PROMETHEUS_NEO4J_URI=bolt://localhost:7687
PROMETHEUS_DATABASE_URL=postgresql+asyncpg://postgres:password@localhost:5432/postgres
```

### 4. 运行开发服务器

```bash
uvicorn prometheus.app.main:app --host 0.0.0.0 --port 9002 --reload
```

`--reload` 参数会在代码更改时自动重启服务器。

## 运行测试

### 运行所有测试

```bash
pytest -v -s
```

### 运行特定测试

```bash
# 运行特定文件
pytest tests/app/services/test_issue_service.py -v

# 运行特定测试函数
pytest tests/app/services/test_issue_service.py::test_answer_issue -v
```

### 生成覆盖率报告

```bash
coverage run --source=prometheus -m pytest -v -s -m "not git"
coverage report -m
coverage html
open htmlcov/index.html  # 在浏览器中查看
```

## 常见问题

### 1. Docker 容器启动失败

**症状**：`docker-compose up` 失败

**解决方案**：
- 确保 Docker 和 Docker Compose 已正确安装
- 检查端口是否被占用（9002, 7474, 7687, 5432）
- 查看日志：`docker-compose logs`

### 2. Neo4j 连接失败

**症状**：`Connection refused` 或 `Authentication failed`

**解决方案**：
- 确保 Neo4j 容器正在运行：`docker ps`
- 验证连接信息在 `.env` 中是否正确
- 在浏览器访问 http://localhost:7474 验证 Neo4j 是否正常

### 3. LLM API 调用失败

**症状**：`Invalid API key` 或 `Rate limit exceeded`

**解决方案**：
- 验证 API 密钥是否正确
- 检查 API 额度是否用完
- 尝试切换到其他 LLM 提供商

### 4. 工作目录权限问题

**症状**：`Permission denied` 错误

**解决方案**：
```bash
# 确保工作目录存在且有写权限
mkdir -p working_dir
chmod 755 working_dir
```

### 5. JWT 密钥未设置

**症状**：`JWT secret key not configured`

**解决方案**：
```bash
# 生成 JWT 密钥
python -m prometheus.script.generate_jwt_token

# 复制输出并添加到 .env
```

## 下一步

现在你已经成功运行 Prometheus，可以：

1. **探索 API 文档**：访问 http://localhost:9002/docs 查看所有可用的端点
2. **了解架构**：阅读 [架构设计](./架构设计.md) 深入理解系统原理
3. **参与开发**：参考 [开发指南](./开发指南.md) 贡献代码
4. **查看示例**：在 `tests/` 目录下查看测试用例了解使用方式

## 获取帮助

如果遇到问题，可以通过以下方式寻求帮助：

- **查看文档**：[完整文档列表](../README.md)
- **GitHub Issues**：[提交问题](https://github.com/EuniAI/Prometheus/issues)
- **Discord 社区**：[加入讨论](https://discord.gg/jDG4wqkKZj)
- **邮件支持**：business@euni.ai

祝你使用愉快！
